# T1547.001 – Registry Run Keys / Startup Folder

## Technique Description

**MITRE ATT&CK ID:** T1547.001  
**Tactic:** Persistence
**Platform:** Windows

Registry Run Keys are a Windows persistence mechanism that allows programs to automatically execute when a user logs on. By adding a malicious command or executable path to the Run registry key, adversaries ensure their payload is launched repeatedly without requiring further interaction.

Attackers commonly abuse this technique because it relies on legitimate Windows functionality and does not necessarily require administrative privileges when targeting user-level registry hives (HKCU).

**Real-World Usage:**  
Threat actors such as **APT28**, **APT33**, and multiple ransomware families have leveraged Run key persistence to maintain access across reboots and user logons.

---

## Atomic Red Team Test

**Test Number:** Test #1  
**Supported Platforms:** Windows

### Test Command
```REG ADD "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "Atomic Red Team" /t REG_SZ /F /D "#{command_to_execute}"
```

**Parameters:**
- `REG ADD` - Creates or modifies a registry value
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` - User-level Run key executed at logon
- `/V "Atomic Red Team"` - Name of the registry value added
- `/t REG_SZ` - Specifies a string valuee
- `/F` - Forces overwrite if the value already exists
- `/D "#{command_to_execute}"` - Path to the executable that will run persistently

### Expected Behavior
When executed, the command adds a new value to the user’s Run registry key. The specified executable will automatically launch every time the user logs on, simulating attacker persistence via registry modification.

---

## Sigma Rule

```yaml
title: Registry Run Key Persistence via reg.exe
id: e55be3fd-t1547-001-reg-run
status: experimental
description: >
  Detects the creation of user-level Run registry keys using reg.exe, a common persistence mechanism abused by attackers to execute payloads at user logon
references:
  - https://attack.mitre.org/techniques/T1547/001/
  - https://github.com/redcanaryco/atomic-red-team
author: Ghofrane Amemi
date: 2026-02-01
tags:
  - attack.persistence
  - attack.t1547
  - attack.t1547.001
  - atomic_red_team

logsource:
  product: windows
  category: process_creation
  service: sysmon

detection:
  selection_reg:
    Image|endswith: '\reg.exe'
    CommandLine|contains:
      - 'HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run'
      - 'REG ADD' 

  condition: selection_reg

falsepositives:
  - Legitimate software installers
  - Administrative startup scripts
  - Enterprise endpoint management tools

level: medium
```

---

## Kibana Detection Query

**Rule Name:** T1547.001 – Registry Run Key Persistence
**Severity:** Medium

### KQL Query
```kql
winlog.channel: "Microsoft-Windows-Sysmon/Operational"
AND event.code: "1"
AND process.name: "reg.exe"
AND process.command_line.text: "*CurrentVersion\\Run*"
AND process.command_line.text: "*REG ADD*"
```

---

### Required Data Sources
- **Log Source:** Sysmon
- **Event ID:** 1 (Process Creation)
- **Channel:** Microsoft-Windows-Sysmon/Operational

---

## Limitations

This detection does not cover:
- Persistence created via PowerShell registry cmdlets
- Autoruns via Startup Folder
- Registry modifications performed through direct API calls
- Persistence written under HKLM Run keys without process creation telemetry
