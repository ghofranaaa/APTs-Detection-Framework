# T1546.001 - Event Triggered Execution: Change Default File Association

## Technique Description

**MITRE ATT&CK ID:** T1546.001  
**Tactic:** Persistence
**Platform:** Windows

Adversaries may establish persistence by modifying file associations to execute malicious content when specific file types are opened. When a file is opened, Windows checks the default program (file association) in the Registry. Attackers abuse this by associating common file extensions with malicious programs, ensuring their payload executes whenever users open those file types.

**Real-World Usage:**  
This technique has been used by **APT28** (Fancy Bear) to maintain persistence on compromised systems by modifying file associations for commonly used file types.

---

## Atomic Red Team Test

**Test Number:** Test #1  
**Supported Platforms:** Windows

### Test Command
```cmd
assoc #{extension_to_change}=#{target_extension_handler}
```

**Parameters:**
- `#{extension_to_change}` - The file extension to modify (e.g., `.hta`)
- `#{target_extension_handler}` - The file type handler to associate with (e.g., `htafile`)

### Expected Behavior
When executed, this command changes the default file association for the specified extension. In a real attack scenario, attackers would combine this with `ftype` to redirect the file handler to a malicious executable. The malware would then execute automatically whenever a user opens files with that extension, providing persistence across system reboots.

---

## Sigma Rule

```yaml
title: Change Default File Association for HTA Files
id: 9b3a7c6e-hta-assoc-1546-001
status: experimental
description: >
  Detects modification of the default file association for .hta files,
  which may indicate persistence via Event Triggered Execution (T1546.001).
references:
  - https://attack.mitre.org/techniques/T1546/001/
  - https://github.com/redcanaryco/atomic-red-team
author: Ghofrane Amemi
date: 2026-01-22
tags:
  - attack.persistence
  - attack.t1546
  - attack.t1546.001
  - atomic_red_team

logsource:
  product: windows
  category: process_creation
  service: sysmon

detection:
  selection_cmd:
    Image|endswith: '\cmd.exe'
    CommandLine|contains:
      - 'assoc'
      - '.hta='
  selection_parent:
    ParentImage|endswith: '\wsmprovhost.exe'  


  condition: selection_cmd and selection_parent

falsepositives:
  - Rare system administration activity
  - Legacy application configuration

level: high
```

---

## Kibana Detection Query

**Rule Name:** T1546.001 - Persistence via HTA File Association 
**Severity:** Medium

### KQL Query
```kql
winlog.channel: "Microsoft-Windows-Sysmon/Operational" 
AND event.code: "1" 
AND process.name: "cmd.exe" 
AND (process.command_line.text: "*assoc*" OR process.command_line.text: "*ftype*")
```

---

### Required Data Sources
- **Log Source:** Sysmon
- **Event ID:** 1 (Process Creation)
- **Channel:** Microsoft-Windows-Sysmon/Operational

---

## Limitations

This detection rule can only alert on the **initial execution** of the file association modification. If the attacker successfully modifies the file association and does not perform cleanup, subsequent executions of the modified file type will **not trigger additional alerts**. The rule only detects the modification attempt itself, not the ongoing abuse of the modified association.

To detect ongoing exploitation, additional monitoring of the newly associated executable would be required.