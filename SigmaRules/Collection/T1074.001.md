# T1074.001 – Local Data Staging

## Technique Description

**MITRE ATT&CK ID:** T1074.001
**Tactic:** Collection 
**Platform:** Windows

Adversaries use Local Data Staging to collect, aggregate, and store information locally on a compromised system before exfiltration. Instead of immediately sending collected data over the network, attackers often stage it in temporary directories or files to reduce network noise, evade detection, and prepare the data for later transfer.

On Windows systems, this behavior frequently involves downloading or executing scripts that perform discovery and redirect the output into files located in temporary or user-writable directories (e.g., %TEMP%). PowerShell is commonly abused for this purpose due to its native support for file downloads and script execution.

**Real-World Usage:**  
Threat actors such as APT28 have been observed staging collected discovery output locally prior to exfiltration, allowing them to consolidate reconnaissance results and minimize suspicious outbound traffic during early post-exploitation phases.

---

## Atomic Red Team Test

**Test Number:** Test #1  
**Supported Platforms:** Windows

### Test Command
```
Invoke-WebRequest "https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1074.001/src/Discovery.bat" -OutFile #{output_file}
```

**Parameters:**
- `Invoke-WebRequest` - Downloads a remote resource over HTTP/HTTPS

- `Discovery.bat` - Batch script containing multiple discovery commands

- `#{output_file}` - Output path, typically a temporary directory


### Expected Behavior
When executed, PowerShell downloads the Discovery.bat script from a remote repository and saves it locally, usually in a temporary directory. This script, once executed, gathers system and environment information and stages the collected output locally for later use.

---

## Sigma Rule

```yaml
title: PowerShell Download of Discovery Script to Temp Directory
id: 8f3c2e9a-7a4e-4c9f-b2d6-9b4c6d7a1074
status: experimental
description: >
  Detects PowerShell downloading a discovery script and staging it locally
  in a temporary directory, consistent with Local Data Staging behavior.
references:
  - https://attack.mitre.org/techniques/T1074.001
  - https://github.com/redcanaryco/atomic-red-team
author: Ghofrane Amemi
date: 2026-01-26
tags:
  - attack.collection
  - attack.1074
  - attack.t074.001
  - atomic_red_team

logsource:
  product: windows
  category: process_creation
  service: sysmon

detection:
  selection_pwrsh:
    Image|endswith: '\powershell.exe'
    CommandLine|contains:
      - 'Disovery.bat'

  selection_parent:
    ParentImage|endswith: '\wsmprovhost.exe'

  condition: selection_pwrsh and selection_parent

falsepositives:
  - Legitimate administrative scripts downloaded via PowerShell
  - Security testing or red team activity

level: high
```
---

## Kibana Detection Query

**Rule Name:** T1074.001 – Local Data Staging
**Severity:** High

### KQL Query
```kql
winlog.channel: "Microsoft-Windows-Sysmon/Operational"
AND event.code: "1"
AND process.name: "powershell.exe"
AND process.command_line.text: "*Discovery.bat*"
```

### Required Data Sources
- **Log Source:** Sysmon
- **Event ID:** 1 (Process Creation)
- **Channel:** Microsoft-Windows-Sysmon/Operational

---

## Limitations

This detection focuses on PowerShell-based local staging and will not detect:
- Data staged via in-memory-only techniques
- Discovery scripts embedded directly in PowerShell without file writes
- Staging performed via non-PowerShell binaries