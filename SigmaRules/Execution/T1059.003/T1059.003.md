# T1059.003 - Command and Scripting Interpreter: Windows Command Shell

## Technique Description

**MITRE ATT&CK ID:** T1059.003  
**Tactic:** Execution  
**Platform:** Windows

Adversaries abuse the Windows Command Shell (cmd.exe) to execute commands, scripts, and programs on compromised systems. The Windows command shell is a legitimate system tool that provides access to various system functions and can be used to run batch files, execute binaries, and manipulate files. Attackers leverage cmd.exe for executing malicious commands, running scripts, performing reconnaissance, and establishing persistence because it's a trusted Windows component that often evades basic security controls.

**Real-World Usage:**  
This technique has been used by **APT28** (Fancy Bear) to execute reconnaissance commands and stage payloads on compromised systems by abusing cmd.exe for file operations and command execution.

---

## Atomic Red Team Test

**Test Number:** Test #2  
**Supported Platforms:** Windows

### Test Command
```cmd
echo #{message} > #{output_file}
type #{output_file}
del #{output_file}
```

**Parameters:**
- `#{message}` - Text to write to the file (e.g., "Hello from the Windows Command Prompt!")
- `#{output_file}` - Target file path (e.g., %TEMP%\test.bin)

### Expected Behavior
When executed, this test uses cmd.exe to write text to a file in the TEMP directory, read it back, and then delete it. This simulates how attackers use the command shell to stage malicious payloads, scripts, or configuration files on compromised systems. In a real attack scenario, the text content would be replaced with malicious code, scripts, or encoded payloads that are then executed to maintain persistence or perform malicious activities.

---

## Sigma Rule

```yaml
title: Suspicious CMD File Operations in TEMP Directory via Remote Execution
id: a7b3c8d9-4e5f-6a7b-8c9d-0e1f2a3b4c5d
status: experimental
description: Detects cmd.exe writing and reading files in TEMP directory via remote execution
references:
    - https://attack.mitre.org/techniques/T1059/003/
author: Ghofrane Amemi
date: 2025/01/24
tags:
  - attack.execution
  - attack.t1059
  - attack.t1059.003
  - atomic_red_team

logsource:
  product: windows
  category: process_creation
  service: sysmon

detection:
  selection_cmd:
    Image|endswith: '\cmd.exe'
    CommandLine|contains:
      - 'echo'
      - 'type'
  selection_parent:
    ParentImage|endswith: '\wsmprovhost.exe'  


  condition: selection_cmd and selection_parent

falsepositives:
  - Legitimate remote administration scripts
  - Automated deployment tools

level: high

```

---

## Kibana Detection Query

**Rule Name:** T1059.003 - Writes text to a file and displays it
**Severity:** High

### KQL Query
```kql
winlog.channel: "Microsoft-Windows-Sysmon/Operational"
AND event.code: "1"
AND process.name: "cmd.exe"
AND process.parent.name: "wsmprovhost.exe"
AND process.command_line.text: (*echo* AND *type*)
```

---

### Required Data Sources
- **Log Source:** Sysmon
- **Event ID:** 1 (Process Creation)
- **Channel:** Microsoft-Windows-Sysmon/Operational

---

## Limitations

This detection rule focuses specifically on the file write-read-delete pattern in the TEMP directory executed via WinRM. It will not detect:
- Local execution of similar commands (non-remote)
- File operations in directories other than TEMP
- Obfuscated commands that avoid the specific keywords (echo, type, TEMP)
- PowerShell-based equivalents of the same technique
- Commands executed through other remote access methods (RDP, SSH, etc.)

The rule is optimized for detecting remote command shell abuse for file staging operations, which is a common post-exploitation pattern.